<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IAH - Quiz de Texto</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Roboto+Mono:wght@400;500&display=swap"
    rel="stylesheet">

  <style>
    /* --- TEMA "DEEP FREEZE" (Azul Profundo e Ciano) --- */

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }

    body {
      /* Gradiente Azul Profundo */
      background: linear-gradient(135deg, #02111D 0%, #004e92 100%);
      color: #e0f7fa;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      user-select: none;
    }

    .hidden {
      display: none !important;
    }

    .screen {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      padding: 30px;
      border-radius: 16px;
      width: 100%;
      max-width: 950px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.1);
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      color: #00cc99; /* Ciano-Esmeralda */
      text-align: center;
      margin-bottom: 20px;
      font-weight: 600;
    }

    /* Botões */
    .btn {
      background: linear-gradient(90deg, #00c6ff, #0072ff);
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      text-transform: uppercase;
      margin-top: 25px;
      transition: 0.2s;
      width: 100%;
      box-shadow: 0 4px 15px rgba(0, 198, 255, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 198, 255, 0.5);
    }

    /* Inputs e Selects */
    .screen input[type="number"],
    .screen select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #2c3e50;
      border-radius: 4px;
      background-color: rgba(0, 0, 0, 0.4);
      color: #e0f7fa;
      font-size: 16px;
    }
    
    .screen input:focus, .screen select:focus {
        outline: none;
        border-color: #00cc99;
    }

    .screen label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #4facfe;
    }

    .timer {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #00cc99;
      color: #1e1e1e;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9em;
      font-weight: 600;
    }

    /* --- CONTEÚDO DO TEXTO --- */
    .media-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .dual {
        flex-direction: row;
    }

    .text-card {
      background: #f0f8ff; /* Papel claro para leitura */
      color: #1a2a3a;
      padding: 20px;
      border-left: 5px solid #00c6ff;
      border-radius: 5px;
      font-family: 'Roboto Mono', monospace;
      font-size: 15px;
      line-height: 1.6;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .dual .text-card { width: 50%; font-size: 13px; }

    /* --- CONTROLES DO QUIZ --- */
    .quiz-controls {
      display: flex;
      gap: 20px;
      margin-top: 25px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .control-box {
      flex: 1;
      min-width: 55px;
      padding: 15px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid #2c3e50;
    }

    .control-box h4 {
      margin-bottom: 7px;
      color: #00cc99;
      font-weight: 600;
      border-bottom: 1px solid #2c3e50;
      padding-bottom: 5px;
    }

    /* Radio Buttons (Decisão) */
    .radio-group {
      display: flex;
      gap: 15px;
      flex-direction: column;
    }

    .radio-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border: 2px solid #2c3e50;
      border-radius: 6px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.05);
      transition: 0.2s ease;
    }

    .radio-option:hover {
      border-color: #00c6ff;
      background: rgba(0, 198, 255, 0.1);
    }

    .radio-option input {
      margin: 0;
      accent-color: #00c6ff;
      transform: scale(1.2);
    }

    .radio-option:has(input:checked) {
      border-color: #00c6ff;
      background: rgba(0, 198, 255, 0.2);
    }

    /* --- BOLINHAS DE CONFIANÇA (AZUL) --- */
    .confidence-wrapper { margin-top: 10px; }

    .scale-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 5px;
      text-align: center;
    }

    .scale-label {
      font-size: 10px;
      color: #aaa;
      font-weight: 400;
      text-transform: uppercase;
      display: block;
      margin-top: 3px;
    }

    .scale-btn { display: block; cursor: pointer; }
    .scale-btn input { display: none; }

    .scale-btn .circle {
      width: 35px;
      height: 35px;
      border: 2px solid #2c3e50;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.3);
      transition: 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #e0f7fa;
    }

    .scale-btn input:checked+.circle {
      background-color: #00c6ff;
      border-color: #00c6ff;
      color: #000;
      transform: scale(1.1);
      box-shadow: 0 0 10px rgba(0, 198, 255, 0.5);
    }

    /* Justificativa */
    #justificativa-wrapper { margin-top: 20px; }
    #quiz-justificativa {
      width: 100%;
      height: 80px;
      padding: 15px;
      border: 1px solid #2c3e50;
      border-radius: 6px;
      background-color: rgba(0, 0, 0, 0.4);
      color: #e0f7fa;
      font-size: 14px;
      resize: vertical;
    }

    /* Gabarito */
    .answer-item {
      padding: 15px;
      border-radius: 8px;
      border-left: 5px solid;
      margin-bottom: 15px;
      background: rgba(0, 0, 0, 0.2);
    }
    .answer-item.correct { border-left-color: #00cc99; }
    .answer-item.incorrect { border-left-color: #ff4d4d; }
    .text-preview {
        font-family: 'Roboto Mono', monospace;
        font-size: 12px;
        color: #ccc;
        background: rgba(0,0,0,0.3);
        padding: 10px;
        margin: 10px 0;
    }
    .summary-results {
        background: rgba(0,0,0,0.3);
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 20px;
        font-size: 1.2em;
        color: #00c6ff;
    }

    /* Responsivo */
    @media (max-width: 768px) {
      .quiz-controls { flex-direction: column; }
      .dual { flex-direction: column; }
      .dual .text-card { width: 100%; }
    }
    
    /* Consentimento checkbox */
    .consent-wrapper {
        margin-top: 20px;
        padding: 15px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 6px;
        border: 1px solid #2c3e50;
    }
    .consent-label {
        display: flex;
        align-items: center;
        font-size: 14px;
        color: #fff;
        cursor: pointer;
    }
    .consent-label input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
        transform: scale(1.2);
        accent-color: #00cc99;
    }
  </style>
</head>

<body>

  <div id="screen-start" class="screen">
    <h2>IAH - Análise Textual</h2>
    <p style="text-align:center; color:#aaa;">Preencha os dados para iniciar.</p>

    <form id="form-start">
      <label for="idade">Idade:</label>
      <input type="number" id="idade" name="idade" required min="12" max="85">
  
      <label for="genero">Gênero:</label>
      <select id="genero" name="genero" required>
          <option value="">Selecione</option>
          <option value="F">Feminino</option>
          <option value="M">Masculino</option>
          <option value="O">Outro</option>
      </select>
      
      <label for="escolaridade">Escolaridade:</label>
      <select id="escolaridade" name="escolaridade" required>
          <option value="">Selecione</option>
          <option value="Fundamental">Fundamental</option>
          <option value="Medio_Incompleto">Médio (Incompleto)</option>
          <option value="Medio_Completo">Médio (Completo)</option>
          <option value="MedioTecnico">Médio/Técnico</option>
          <option value="Superior">Superior</option>
          <option value="Pos_Graduacao">Pós-Graduação</option>
      </select>
      
      <div id="tecnico-field-wrapper" class="hidden">
          <label style="color:#00c6ff;">Qual curso técnico?</label>
          <select id="curso_tecnico" name="curso_tecnico">
              <option value="">Selecione</option>
              <option value="Informatica">Informática</option>
              <option value="Agricultura">Agricultura</option>
              <option value="Outro">Outro</option>
          </select>
      </div>

      <label for="nivel_ia">Conhecimento sobre IA:</label>
      <select id="nivel_ia" name="nivel_ia" required>
          <option value="">Selecione</option>
          <option value="Nulo">Nulo</option>
          <option value="Basico">Básico</option>
          <option value="Intermediario">Intermediário</option>
          <option value="Avancado">Avançado</option>
      </select>
  
      <div class="consent-wrapper">
          <label class="consent-label">
              <input type="checkbox" name="consentimento" value="sim" required>
              Declaro que li e concordo com os Termos de Consentimento.
          </label>
      </div>
      <button class="btn" type="submit">Iniciar Quiz</button>
  </form>
    <div id="loading-start" class="hidden" style="text-align: center; margin-top: 20px;">Carregando...</div>
  </div>

  <div id="screen-quiz" class="screen hidden">
    <p class="timer">Tempo: <span id="quiz-timer">00:00</span></p>

    <form id="form-quiz">
      <h3 id="quiz-pergunta" style="color:#00cc99;"></h3>

      <div id="media-wrapper" class="media-container"></div>

      <div class="quiz-controls">

        <div id="quiz-decision-wrapper" class="control-box decision-box">
          <h4>Resposta:</h4>
          <div class="radio-group" id="decision-options">
             </div>
        </div>

        <div class="control-box confidence-box">
          <h4>Nível de Confiabilidade</h4>
          <div class="confidence-wrapper">
            <div class="scale-container">
                <span class="scale-label">Zero confiança</span>
                <div style="display:flex; gap:8px;">
                  <label class="scale-btn"><input type="radio" name="confidence" value="1" required><span class="circle">1</span></label>
                  <label class="scale-btn"><input type="radio" name="confidence" value="2"><span class="circle">2</span></label>
                  <label class="scale-btn"><input type="radio" name="confidence" value="3"><span class="circle">3</span></label>
                  <label class="scale-btn"><input type="radio" name="confidence" value="4"><span class="circle">4</span></label>
                  <label class="scale-btn"><input type="radio" name="confidence" value="5"><span class="circle">5</span></label>
                </div>
                <span class="scale-label">Confiança Alta</span>
            </div>
          </div>
        </div>
      </div>

      <div id="justificativa-wrapper">
        <label for="quiz-justificativa">3. Justificativa (Opcional)</label>
        <textarea id="quiz-justificativa" name="justificativa" placeholder="O que denunciou a autoria?"></textarea>
      </div>

      <button class="btn" type="submit">Próximo</button>
    </form>
  </div>

  <div id="screen-answer-key" class="screen hidden">
    <h2>Gabarito Final</h2>
    <div class="summary-results"></div>
    <div id="answer-key-content">
      <p style="text-align:center">Carregando resultados...</p>
    </div>
    <button class="btn" onclick="location.reload()">Novo Teste</button>
  </div>

  <div id="screen-error" class="screen hidden">
    <h2>Ops!</h2>
    <p id="error-message">Erro no sistema.</p>
    <button class="btn" onclick="location.reload()">Tentar Novamente</button>
  </div>

  <script>
    const state = {
      id_participante: null,
      codigo_gerado: null,
      questions: [],
      currentIdx: 0,
      score: 0,
      answers: [],
      logs: [],
      startTime: null,
      timerInterval: null
    };

    function show(screenId) {
      document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
      document.getElementById(screenId).classList.remove('hidden');
    }

    function log(type, details = {}) {
      state.logs.push({
        timestamp: Date.now(),
        event_type: type,
        details: details 
      });
    }

    // --- Lógica Condicional (Curso Técnico) ---
    document.addEventListener("DOMContentLoaded", () => {
      const escolaridadeSelect = document.getElementById('escolaridade');
      const tecnicoWrapper = document.getElementById('tecnico-field-wrapper');
      const cursoTecnicoSelect = document.getElementById('curso_tecnico');

      escolaridadeSelect.addEventListener('change', function() {
        if (this.value === 'MedioTecnico') {
          tecnicoWrapper.classList.remove('hidden');
          cursoTecnicoSelect.setAttribute('required', 'required');
        } else {
          tecnicoWrapper.classList.add('hidden');
          cursoTecnicoSelect.removeAttribute('required');
          cursoTecnicoSelect.value = "";
        }
      });
      
      show('screen-start');
      log('app_start');
    });

    // 1. REGISTRO
    document.getElementById('form-start').addEventListener('submit', async (e) => {
      e.preventDefault();
      document.getElementById('loading-start').classList.remove('hidden');
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());

      try {
        const response = await fetch('IAHtextregistro.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();

        if (result.success) {
          state.id_participante = result.id_participante;
          state.codigo_gerado = result.codigo_gerado;
          log('register_success', { pid: state.id_participante });
          loadQuestions();
        } else {
          alert('Erro no registro: ' + result.error);
          document.getElementById('loading-start').classList.add('hidden');
        }
      } catch (error) {
        alert('Erro de conexão.');
        document.getElementById('loading-start').classList.add('hidden');
      }
    });

    // 2. BUSCA PERGUNTAS
    async function loadQuestions() {
      try {
        const response = await fetch('IAHtextbuscar.php');
        const data = await response.json();

        if (data.length > 0) { // O PHP retorna array direto
          state.questions = data;
          state.currentIdx = 0;
          show('screen-quiz');
          renderQuestion();
        } else {
          throw new Error('Nenhuma pergunta recebida.');
        }
      } catch (error) {
        document.getElementById('error-message').innerText = error.message;
        show('screen-error');
      }
    }

    // 3. RENDERIZA PERGUNTA
    function renderQuestion() {
      const q = state.questions[state.currentIdx];
      
      // Texto da Pergunta
      document.getElementById('quiz-pergunta').innerText = `Pergunta ${state.currentIdx + 1}: ${q.texto}`;
      
      // Renderiza os Textos (Conteúdo)
      const mediaDiv = document.getElementById('media-wrapper');
      mediaDiv.className = (q.modo === 'comparativo') ? 'media-container dual' : 'media-container';
      mediaDiv.innerHTML = '';
      
      q.conteudos.forEach(texto => {
          const card = document.createElement('div');
          card.className = 'text-card';
          card.innerText = texto;
          card.onmouseup = () => { if(window.getSelection().toString().length>0) log('text_select'); }; // Espião
          mediaDiv.appendChild(card);
      });

      // Renderiza Opções de Decisão
      const decisionWrapper = document.getElementById('decision-options');
      decisionWrapper.innerHTML = '';
      let optionsHTML = '';

      if (q.modo === 'padrao') {
          optionsHTML = `
            <label class="radio-option">É IA <input type="radio" name="main_decision" value="ia" required></label>
            <label class="radio-option">É Humano <input type="radio" name="main_decision" value="humano"></label>
          `;
      } else if (q.modo === 'comparativo') {
          optionsHTML = `
            <label class="radio-option">Texto A é IA <input type="radio" name="main_decision" value="texto_a" required></label>
            <label class="radio-option">Texto B é IA <input type="radio" name="main_decision" value="texto_b"></label>
          `;
      } else if (q.modo === 'analise') {
          optionsHTML = `
            <label class="radio-option">Concordo <input type="radio" name="main_decision" value="concordo" required></label>
            <label class="radio-option">Discordo <input type="radio" name="main_decision" value="discordo"></label>
          `;
      } else if (q.modo === 'aberta') {
          // Esconde decisão e confiança, mostra só justificativa obrigatória
          document.querySelector('.decision-box').classList.add('hidden');
          document.querySelector('.confidence-box').classList.add('hidden');
          document.getElementById('quiz-justificativa').required = true;
          optionsHTML = `<input type="hidden" name="main_decision" value="texto_livre">`;
      }

      if (q.modo !== 'aberta') {
          document.querySelector('.decision-box').classList.remove('hidden');
          document.querySelector('.confidence-box').classList.remove('hidden');
          document.getElementById('quiz-justificativa').required = false;
      }

      decisionWrapper.innerHTML = optionsHTML;

      // Timer Reset
      if(state.timerInterval) clearInterval(state.timerInterval);
      state.startTime = Date.now();
      document.getElementById('quiz-timer').innerText = '00:00';
      state.timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
        const min = String(Math.floor(elapsed/60)).padStart(2,'0');
        const sec = String(elapsed%60).padStart(2,'0');
        document.getElementById('quiz-timer').innerText = `${min}:${sec}`;
      }, 1000);

      log('view_question', { id: q.item_id, modo: q.modo });
    }

    // 4. ENVIO DA RESPOSTA
    document.getElementById('form-quiz').addEventListener('submit', (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const q = state.questions[state.currentIdx];
      
      const main = fd.get('main_decision');
      const conf = fd.get('confidence') || 0;
      
      // Cria a string composta para o banco
      const finalChoice = (q.modo === 'aberta') ? 'texto_livre' : `${main}_confianca_${conf}`;

      // Correção local (simplificada)
      let isCorrect = false;
      if (q.modo === 'padrao') isCorrect = (main === q.gabarito);
      else if (q.modo === 'comparativo') isCorrect = (main === q.gabarito);
      else isCorrect = true; // Aberta/Analise conta como acerto pela participação

      if(isCorrect) state.score++;

      state.answers.push({
        id: q.item_id,
        pergunta: q.texto,
        choice: finalChoice,
        isCorrect: isCorrect,
        timeTaken: (Date.now() - state.startTime) / 1000,
        justificativa: document.getElementById('quiz-justificativa').value
      });

      state.currentIdx++;
      if (state.currentIdx < state.questions.length) {
        renderQuestion();
      } else {
        finishQuiz();
      }
    });

    // 5. FINALIZAR
    async function finishQuiz() {
      clearInterval(state.timerInterval);
      show('screen-answer-key');
      
      // Renderiza resumo inicial
      const summary = document.querySelector('.summary-results');
      summary.innerHTML = `<p>Pontuação: <strong>${state.score}</strong> de ${state.questions.length}</p>`;
      
      const content = document.getElementById('answer-key-content');
      
      // Monta gabarito visual
      let html = '';
      state.answers.forEach((ans, i) => {
          const status = ans.isCorrect ? 'ACERTOU' : 'ERROU';
          const colorClass = ans.isCorrect ? 'correct' : 'incorrect';
          const qReal = state.questions.find(q => q.item_id == ans.id); // Tenta achar dados originais
          
          html += `
            <div class="answer-item ${colorClass}">
                <div class="header-result">
                    <h4>Pergunta ${i+1}</h4>
                    <span style="font-weight:bold;">${status}</span>
                </div>
                <p style="font-size:12px; margin-top:5px;">Sua escolha: <strong>${ans.choice}</strong></p>
                <p style="font-size:12px;">Tempo: ${ans.timeTaken.toFixed(1)}s</p>
            </div>
          `;
      });
      content.innerHTML = html;

      // Salva no Banco
      try {
        await fetch('IAHtextsalvar.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id_participante: state.id_participante,
            respostas: state.answers,
            logs: state.logs
          })
        });
        log('quiz_saved');
      } catch (err) {
        console.error("Erro ao salvar:", err);
        alert("Erro ao salvar resultados no servidor, mas seu gabarito está na tela.");
      }
    }

    // Espiões
    document.addEventListener("copy", () => log('text_copied'));
    document.addEventListener("click", (e) => { 
        if (!e.target.closest('input, button, a, label')) log('click', { x: e.clientX, y: e.clientY }); 
    });
  </script>
</body>
</html>
